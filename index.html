<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Royal Sherwani - POS Terminal</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#800000">
    <link rel="apple-touch-icon" href="icon-192.png">

    <style>
        :root {
            --bg: #f4f1ea;
            --maroon: #800000;
            --gold: #D4AF37;
            --white: #FFFFFF;
            --text-dark: #2c2c2c;
            --text-light: #666;
            --border: #e0e0e0;
        }

        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg); margin: 0; padding: 0; color: var(--text-dark); padding-bottom: 100px; }

        /* --- SETTINGS BTN --- */
        #settings-btn { 
            position: fixed; top: 15px; right: 15px; z-index: 9999; 
            background: white; border: 2px solid var(--maroon); border-radius: 50%; 
            width: 40px; height: 40px; font-size: 20px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: 0.3s;
        }

        /* --- LOGIN SCREEN --- */
        #login-view { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1a1a1a; z-index: 5000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .login-card { background: white; padding: 30px; border-radius: 16px; width: 90%; max-width: 350px; text-align: center; border-top: 5px solid var(--maroon); }
        .login-input { width: 100%; padding: 14px; margin: 10px 0; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; outline: none; background: #f9f9f9; }
        .login-input:focus { border-color: var(--maroon); background: white; }
        
        .btn-primary { 
            background: var(--maroon); color: white; border: none; width: 100%; 
            padding: 14px; border-radius: 8px; font-weight: bold; font-size: 16px; 
            cursor: pointer; margin-top: 10px; box-shadow: 0 4px 10px rgba(128,0,0,0.3);
        }
        .btn-primary:active { transform: scale(0.98); }

        /* --- HEADER --- */
        header { 
            background: var(--maroon); color: white; padding: 15px; 
            display: flex; justify-content: space-between; align-items: center; 
            position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
        }
        .app-title { font-weight: 900; font-size: 18px; letter-spacing: 1px; }
        
        /* STATUS */
        .status-pill { 
            display: flex; align-items: center; gap: 6px; font-size: 10px; font-weight: bold; 
            background: rgba(0,0,0,0.3); padding: 4px 10px; border-radius: 20px; 
            border: 1px solid rgba(255,255,255,0.2); 
        }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #ff4444; border: 1px solid white; transition: 0.3s; }
        .status-dot.online { background: #00ff00; box-shadow: 0 0 8px #00ff00; }
        .online-text { color: #ccffcc; }

        /* --- CONTAINER & CARDS --- */
        .container { padding: 15px; max-width: 600px; margin: auto; }
        
        .card { 
            background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.04); border: 1px solid #eee; 
        }
        .card-header { font-size: 12px; font-weight: 900; color: var(--maroon); text-transform: uppercase; margin-bottom: 10px; letter-spacing: 0.5px; display: flex; justify-content: space-between; align-items: center; }

        /* INPUTS */
        label { font-size: 12px; font-weight: bold; color: #555; display: block; margin-bottom: 4px; }
        .inp { 
            width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; 
            font-size: 15px; margin-bottom: 10px; outline: none; background: #fff;
        }
        .inp:focus { border-color: var(--maroon); }

        /* TOP ACTIONS GRID */
        .action-grid { display: grid; grid-template-columns: 1fr 1.2fr 1fr; gap: 8px; margin-bottom: 15px; }
        .act-btn { 
            background: white; border: 1px solid var(--gold); padding: 12px 5px; 
            border-radius: 8px; color: var(--maroon); font-weight: bold; font-size: 11px; 
            cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 4px;
            white-space: nowrap;
        }
        .act-btn:active { background: #fff8e1; }

        /* --- ITEM CARD DESIGN --- */
        .item-card { 
            background: #fff; border-left: 4px solid var(--maroon); 
            border-radius: 8px; padding: 12px; margin-bottom: 10px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative;
        }
        
        .row-flex { display: flex; gap: 10px; align-items: center; margin-bottom: 8px; }
        .inp-name { flex: 70%; font-weight: bold; }
        .inp-price { flex: 30%; text-align: center; font-weight: bold; color: var(--maroon); }

        /* UPDATED CHECKBOX STYLES */
        .opt-grid { 
            display: flex; flex-wrap: wrap; gap: 8px; margin: 8px 0; 
            padding: 8px; background: #f9f9f9; border-radius: 6px; border: 1px solid #eee;
        }
        .chk-lbl { 
            font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 6px; 
            background: white; padding: 8px 12px; border-radius: 6px; border: 1px solid #ccc; color: #333;
        }
        .chk-lbl input { transform: scale(1.4); margin: 0; cursor: pointer; }

        .card-actions { display: flex; justify-content: space-between; align-items: center; margin-top: 5px; }
        .btn-scan { background: var(--gold); color: black; padding: 6px 12px; border-radius: 4px; font-size: 11px; border: none; font-weight: bold; display: none;}
        
        /* RM Logic */
        body.rm-mode .btn-scan { display: inline-block; }

        /* TOGGLE SWITCH */
        .switch { position: relative; display: inline-block; width: 44px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--gold); }
        input:checked + .slider:before { transform: translateX(22px); }

        /* MODALS */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 6000; align-items: flex-start; justify-content: center; overflow-y: auto; padding-top: 20px; }
        .modal-content { background: white; width: 95%; max-width: 450px; padding: 20px; border-radius: 12px; position: relative; }
        
        /* MEASUREMENT LAYOUT (Updated) */
        .measure-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .m-section { background: #f8f8f8; padding: 10px; border-radius: 8px; border: 1px solid #eee; }
        .m-head { font-weight: 900; color: var(--maroon); border-bottom: 2px solid #ddd; margin-bottom: 8px; font-size: 12px; text-transform: uppercase; text-align: center; }
        
        .m-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-size: 13px; font-weight: 600; color: #444; }
        .m-val { width: 70px; padding: 8px; text-align: center; border: 1px solid #ccc; border-radius: 4px; font-weight: bold; outline: none; background: white; }
        .m-val:focus { border-color: var(--maroon); background: #fff8e1; }

        /* FOOTER */
        .footer-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: white; padding: 15px; border-top: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 -4px 15px rgba(0,0,0,0.05); z-index: 4000; }
        .total-label { font-size: 12px; font-weight: bold; color: #666; }
        .total-amount { font-size: 22px; font-weight: 900; color: var(--maroon); line-height: 1; }
        .btn-gen { background: var(--maroon); color: white; border: none; padding: 12px 25px; border-radius: 8px; font-weight: bold; font-size: 16px; }

        .add-item-btn { width: 100%; padding: 12px; border: 2px dashed #ccc; background: white; color: #666; font-weight: bold; border-radius: 8px; cursor: pointer; margin-top: 10px; }
        .add-item-btn:hover { border-color: var(--maroon); color: var(--maroon); }

    </style>
</head>
<body>

    <header id="app-header" style="display:none;">
        <div class="app-title">ROYAL SHERWANI</div>
        <div class="status-pill">
            <div id="status-dot" class="status-dot"></div>
            <span id="status-txt">OFFLINE</span>
        </div>
        <button onclick="logout()" style="background:none; border:none; color:white; font-weight:bold;">LOGOUT</button>
    </header>

    <div id="loading-view" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1a1a1a; z-index: 6000; display: flex; justify-content: center; align-items: center; color: white;">
        <h2>Loading...</h2>
    </div>

    <div id="login-view" style="display: none;">
        <div class="login-card">
            <h2 style="color:var(--maroon);">BILL TERMINAL</h2>
            
            <button id="install-btn" onclick="installPWA()" style="display:none; width:100%; padding:12px; background:#2196f3; color:white; border:none; border-radius:8px; margin-bottom:15px; font-weight:bold; cursor:pointer;">üì≤ INSTALL POS APP</button>

            <input type="email" id="login-email" class="login-input" placeholder="Staff Email">
            <input type="password" id="login-pass" class="login-input" placeholder="Password">
            <button class="btn-primary" onclick="handleLogin()">CONNECT</button>
            <div style="margin-top:20px; color:grey; font-size:12px; cursor:pointer;" onclick="openSettings()">‚öôÔ∏è Database Setup</div>
        </div>
    </div>

    <div id="settings-modal" class="modal" style="align-items:center;">
        <div class="modal-content">
            <h3>Database Config</h3>
            <input type="text" id="set-url" class="inp" placeholder="Supabase URL">
            <input type="text" id="set-key" class="inp" placeholder="Anon Key">
            <button class="btn-primary" onclick="saveSettings()">SAVE & RELOAD</button>
            <button onclick="document.getElementById('settings-modal').style.display='none'" style="width:100%; margin-top:10px; border:none; background:none; color:red;">Close</button>
        </div>
    </div>

    <div id="main-view" class="container" style="display:none;">
        
        <div class="action-grid">
            <button class="act-btn" onclick="openReprint()">üñ®Ô∏è REPRINT</button>
            <button class="act-btn" onclick="openMeasureModal()">üìè ADD MEASURE</button>
            <button class="act-btn" onclick="openUpdateMeasure()">üîÑ UPDATE</button>
        </div>

        <div class="card">
            <div class="card-header">
                SALESMAN INFO
                <span id="next-bill-no" style="background:#eee; padding:2px 6px; border-radius:4px; color:black;">#...</span>
            </div>
            <select id="salesman-select" class="inp" onchange="updateBillSeries()">
                <option value="">Select Name...</option>
            </select>

            <div style="display:flex; gap:10px;">
                <div style="flex:1;">
                    <label>Delivery Date</label>
                    <input type="date" id="del-date" class="inp">
                </div>
                <div style="flex:1.5;">
                    <label>Customer Name</label>
                    <input type="text" id="cust-name" class="inp" placeholder="Full Name">
                </div>
            </div>

            <div style="display:flex; align-items:center; gap:10px; margin-top:10px; background:#e3f2fd; padding:10px; border-radius:8px; border:1px solid #bbdefb;">
                <input type="checkbox" id="is-courier" style="width:20px; height:20px; margin:0;">
                <label for="is-courier" style="font-size:14px; font-weight:bold; color:#1565c0; margin:0; cursor:pointer;">üì¶ Send via Courier</label>
            </div>

            <div id="mobile-container" style="margin-top:10px;">
                <div style="display:flex; gap:5px;">
                    <input type="number" class="cust-mobile inp" placeholder="Mobile Number" style="margin:0;">
                    <button onclick="addMobileField()" style="width:40px; background:#eee; border:1px solid #ccc; border-radius:8px; font-weight:bold;">+</button>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                ORDER ITEMS
                <div style="display:flex; align-items:center; gap:8px; font-size:11px; color:#333; text-transform:none;">
                    Ready Made Mode
                    <label class="switch">
                        <input type="checkbox" id="rm-toggle" onchange="toggleRMMode()">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <div id="items-container"></div>
            
            <button class="add-item-btn" onclick="addItem()">+ ADD ANOTHER PIECE</button>
        </div>

        <div class="card">
            <div class="card-header">PAYMENT DETAILS</div>
            <div style="display:flex; gap:10px;">
                <div style="flex:1">
                    <label>Advance</label>
                    <input type="number" id="adv-amt" class="inp" placeholder="‚Çπ0" oninput="calcTotals()">
                </div>
                <div style="flex:1">
                    <label>Mode</label>
                    <select id="pay-mode" class="inp">
                        <option value="Cash">Cash</option>
                        <option value="Online">Online</option>
                        <option value="Card">Card</option>
                    </select>
                </div>
            </div>
            <div style="text-align:right; font-size:13px; font-weight:bold; color:red;">
                Balance Due: ‚Çπ<span id="bal-amt">0</span>
            </div>
        </div>

    </div>

    <div id="measure-modal" class="modal">
        <div class="modal-content">
            <div class="card-header">
                MEASUREMENTS
                <button onclick="closeModal('measure-modal')" style="border:none; background:none; font-size:20px;">‚úï</button>
            </div>
            
            <div class="measure-layout">
                <div class="m-section">
                    <div class="m-head">LOWER</div>
                    <div class="m-row"><span>Kamar</span><input type="number" id="m-kamar" class="m-val"></div>
                    <div class="m-row"><span>Hips</span><input type="number" id="m-hips" class="m-val"></div>
                    <div class="m-row"><span>Thai</span><input type="number" id="m-thai" class="m-val"></div>
                    <div class="m-row"><span>Asan</span><input type="number" id="m-asan" class="m-val"></div>
                    <div class="m-row"><span>Ghutna</span><input type="number" id="m-ghutna" class="m-val"></div>
                    <div class="m-row"><span>Pindli</span><input type="number" id="m-pindli" class="m-val"></div>
                    <div class="m-row"><span>Mori</span><input type="number" id="m-mori" class="m-val"></div>
                    <div class="m-row"><span>Pent Length</span><input type="number" id="m-pent-len" class="m-val"></div>
                    <div class="m-row"><span>Zuti RM Size</span><input type="number" id="m-zuti" class="m-val"></div>
                    <div class="m-row"><span>Pcs RM Size</span><input type="number" id="m-pcs-rm" class="m-val"></div>
                </div>
                <div class="m-section">
                    <div class="m-head">UPPER</div>
                    <div class="m-row"><span>Pagdi</span><input type="number" id="m-pagdi" class="m-val"></div>
                    <div class="m-row"><span>Neck</span><input type="number" id="m-neck" class="m-val"></div>
                    <div class="m-row"><span>Shoulder</span><input type="number" id="m-shldr" class="m-val"></div>
                    <div class="m-row"><span>Chest</span><input type="number" id="m-chest" class="m-val"></div>
                    <div class="m-row"><span>Pet</span><input type="number" id="m-pet" class="m-val"></div>
                    <div class="m-row"><span>Baju Length</span><input type="number" id="m-baju-len" class="m-val"></div>
                    <div class="m-row"><span>CrossBack</span><input type="number" id="m-cross" class="m-val"></div>
                    <div class="m-row"><span>Length</span><input type="number" id="m-len" class="m-val"></div>
                    <div class="m-row"><span>Upper Length</span><input type="number" id="m-upper-len" class="m-val"></div>
                    <div class="m-row"><span>Inner Length</span><input type="number" id="m-inner-len" class="m-val"></div>
                    <div class="m-row"><span>Baju Mori</span><input type="number" id="m-bmori" class="m-val"></div>
                    <div class="m-row"><span>Byseps</span><input type="number" id="m-biceps" class="m-val"></div>
                </div>
            </div>
            
            <button class="btn-primary" id="btn-save-measure" onclick="saveMeasurements()" style="margin-top:15px;">SAVE SHEET</button>
        </div>
    </div>

    <div id="qr-modal" class="modal" style="align-items:center;">
        <div class="modal-content" style="background:black; padding:0; overflow:hidden;">
            <div id="qr-reader"></div>
            <button class="btn-primary" style="border-radius:0; background:#333;" onclick="stopScanner()">CLOSE CAMERA</button>
        </div>
    </div>

    <div id="app-footer" class="footer-bar" style="display:none;">
        <div>
            <div class="total-label">Total Bill</div>
            <div class="total-amount">‚Çπ<span id="grand-total">0</span></div>
        </div>
        <button class="btn-gen" onclick="saveBill()">GENERATE BILL</button>
    </div>

    <script>
        let supabaseClient;
        let billBookId = null;
        let currentBillNumber = 0;
        let activeRowId = null; 
        let tempMeasurements = {};
        
        let isUpdateMode = false;
        let updateBillId = null; 
        
        let deferredPrompt; 

        // --- PWA INSTALLATION LOGIC ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').then(reg => console.log('SW Registered'));
            });
        }
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault(); deferredPrompt = e;
            document.getElementById('install-btn').style.display = 'block';
        });

        async function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') document.getElementById('install-btn').style.display = 'none';
                deferredPrompt = null;
            }
        }

        // --- NETWORK MONITOR ---
        window.addEventListener('online', updateNetworkStatus);
        window.addEventListener('offline', updateNetworkStatus);

        function updateNetworkStatus() {
            const dot = document.getElementById('status-dot');
            const txt = document.getElementById('status-txt');
            if (navigator.onLine) {
                dot.classList.add('online'); txt.innerText = 'ONLINE'; txt.classList.add('online-text');
            } else {
                dot.classList.remove('online'); txt.innerText = 'OFFLINE'; txt.classList.remove('online-text');
            }
        }

        window.onload = function() {
            updateNetworkStatus();
            const url = localStorage.getItem('rs-url');
            const key = localStorage.getItem('rs-key');
            if(url && key) {
                supabaseClient = supabase.createClient(url, key);
                // Auto-Check Session
                supabaseClient.auth.onAuthStateChange((event, session) => {
                    if (session) {
                        enterApp();
                    } else {
                        document.getElementById('loading-view').style.display = 'none';
                        document.getElementById('login-view').style.display = 'flex';
                    }
                });
            } else {
                document.getElementById('loading-view').style.display = 'none';
                document.getElementById('login-view').style.display = 'flex';
            }
        };

        // --- AUTH & CONFIG ---
        function openSettings() { if(prompt("Code:") === '5563990') document.getElementById('settings-modal').style.display='flex'; }
        function saveSettings() {
            localStorage.setItem('rs-url', document.getElementById('set-url').value.trim());
            localStorage.setItem('rs-key', document.getElementById('set-key').value.trim());
            location.reload();
        }

        async function handleLogin() {
            const e=document.getElementById('login-email').value, p=document.getElementById('login-pass').value;
            const { error } = await supabaseClient.auth.signInWithPassword({email:e, password:p});
            if(error) alert(error.message);
        }

        async function logout() { await supabaseClient.auth.signOut(); location.reload(); }

        function enterApp() {
            document.getElementById('loading-view').style.display='none';
            document.getElementById('login-view').style.display='none';
            document.getElementById('app-header').style.display='flex';
            document.getElementById('main-view').style.display='block';
            document.getElementById('app-footer').style.display='flex';
            
            // RESET UI STATE BEFORE LOADING
            document.getElementById('items-container').innerHTML = ''; // Clear default items
            
            loadSalesmen();
            addItem(); // Add exactly one item
        }

        // --- DATA LOADING ---
        async function loadSalesmen() {
            const { data } = await supabaseClient.from('bill_books').select('*').eq('is_active', true);
            const sel = document.getElementById('salesman-select');
            
            // RESET LIST TO AVOID DUPLICATES
            sel.innerHTML = '<option value="">Select Name...</option>';

            if(data) {
                data.forEach(b => {
                    const opt = document.createElement('option');
                    opt.value = b.id;
                    opt.text = `${b.salesman_name} (${b.start_num}-${b.end_num})`;
                    opt.dataset.start = b.start_num;
                    sel.appendChild(opt);
                });
            }
        }

        async function updateBillSeries() {
            const sel = document.getElementById('salesman-select');
            billBookId = sel.value;
            if(!billBookId) return;
            const { count } = await supabaseClient.from('bills').select('*', { count: 'exact', head: true }).eq('book_id', billBookId);
            currentBillNumber = parseInt(sel.options[sel.selectedIndex].dataset.start) + count;
            document.getElementById('next-bill-no').innerText = `#${currentBillNumber}`;
        }

        // --- ITEM LOGIC ---
        function addItem() {
            const id = Date.now();
            const html = `
            <div class="item-card" id="row-${id}">
                <div class="row-flex">
                    <input type="text" class="inp inp-name" placeholder="Item Name / Design">
                    <input type="number" class="inp inp-price" placeholder="Price" oninput="calcTotals()">
                </div>
                
                <div class="opt-grid">
                    ${['Pagdi','Kalangi','Stall','Mala','Zuti','Pajami','Pent','Waistcoat'].map(opt => 
                        `<label class="chk-lbl"><input type="checkbox" value="${opt}"> ${opt}</label>`
                    ).join('')}
                </div>

                <div style="display:flex; gap:10px;">
                    <input type="text" class="inp inp-note" placeholder="Notes..." style="margin:0;">
                    <input type="text" class="inp inp-inv" placeholder="Linked ID" readonly style="margin:0; width:80px; display:none; background:#eee;">
                </div>

                <div class="card-actions">
                    <span style="flex:1"></span>
                    <button class="btn-scan rm-only" onclick="startScanner('${id}')">üì∑ SCAN QR</button>
                    <button onclick="removeRow('${id}')" style="background:none; border:none; color:red; font-size:12px; margin-left:10px;">Remove</button>
                </div>
            </div>`;
            document.getElementById('items-container').insertAdjacentHTML('beforeend', html);
            toggleRMMode(); // Re-apply RM logic to new card
        }

        function removeRow(id) { document.getElementById(`row-${id}`).remove(); calcTotals(); }

        function toggleRMMode() {
            const isRM = document.getElementById('rm-toggle').checked;
            document.body.classList.toggle('rm-mode', isRM);
        }

        function addMobileField() {
            const div = document.createElement('div');
            div.style.marginTop = '5px';
            div.innerHTML = `<input type="number" class="cust-mobile inp" placeholder="Add. Mobile" style="margin:0;">`;
            document.getElementById('mobile-container').appendChild(div);
        }

        // --- MEASUREMENTS ---
        async function openUpdateMeasure() {
            const b = prompt("Enter Bill Number:");
            if(!b) return;
            const { data } = await supabaseClient.from('bills').select('*').eq('bill_number', b).single();
            if(!data) return alert("Bill Not Found");
            
            isUpdateMode = true;
            updateBillId = data.id;
            tempMeasurements = data.measurements || {}; 
            openMeasureModal(true);
        }

        function openMeasureModal(isUpdate = false) {
            document.getElementById('measure-modal').style.display = 'flex';
            document.getElementById('btn-save-measure').innerText = isUpdate ? "UPDATE DATABASE" : "SAVE SHEET";
            
            // Fill Form from tempMeasurements
            fillForm(tempMeasurements);
        }

        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        // Mappings: ID -> Key Name
        const upperMap = {
            'm-pagdi': 'Pagdi', 'm-neck': 'Neck', 'm-shldr': 'Shoulder', 
            'm-chest': 'Chest', 'm-pet': 'Pet', 'm-baju-len': 'Baju Length',
            'm-cross': 'CrossBack', 'm-len': 'Length', 
            'm-upper-len': 'Upper Length', 'm-inner-len': 'Inner Length',
            'm-bmori': 'Baju Mori', 'm-biceps': 'Byseps'
        };
        const lowerMap = {
            'm-kamar': 'Kamar', 'm-hips': 'Hips', 'm-thai': 'Thai', 'm-asan': 'Asan',
            'm-ghutna': 'Ghutna', 'm-pindli': 'Pindli', 'm-mori': 'Mori', 
            'm-pent-len': 'Pent Length', 'm-zuti': 'Zuti RM', 'm-pcs-rm': 'Pcs RM'
        };

        function fillForm(m) {
            document.querySelectorAll('.m-val').forEach(i=>i.value=''); // Clear
            if(!m) return;

            // Fill Upper
            if(m.upper) {
                for(const [id, key] of Object.entries(upperMap)) {
                    if(m.upper[key]) document.getElementById(id).value = m.upper[key];
                }
            }
            // Fill Lower
            if(m.lower) {
                for(const [id, key] of Object.entries(lowerMap)) {
                    if(m.lower[key]) document.getElementById(id).value = m.lower[key];
                }
            }
        }

        async function saveMeasurements() {
            const getVal = (id) => document.getElementById(id).value;
            
            // Construct Nested Object
            const n = { upper: {}, lower: {} };

            // Collect Upper
            for(const [id, key] of Object.entries(upperMap)) {
                const v = getVal(id);
                if(v) n.upper[key] = v;
            }

            // Collect Lower
            for(const [id, key] of Object.entries(lowerMap)) {
                const v = getVal(id);
                if(v) n.lower[key] = v;
            }

            tempMeasurements = n;

            if(isUpdateMode && updateBillId) {
                const { error } = await supabaseClient.from('bills').update({ measurements: n }).eq('id', updateBillId);
                if(!error) { alert("Updated Successfully!"); closeModal('measure-modal'); isUpdateMode = false; }
                else alert(error.message);
            } else {
                alert("Measurements Saved Temporarily");
                closeModal('measure-modal');
            }
        }

        // --- SCANNER ---
        function startScanner(id) {
            activeRowId = id;
            document.getElementById('qr-modal').style.display='flex';
            html5QrCode = new Html5Qrcode("qr-reader");
            html5QrCode.start({facingMode:"environment"},{fps:10,qrbox:250}, (txt)=>{
                document.querySelector(`#row-${activeRowId} .inp-inv`).value = txt;
                document.querySelector(`#row-${activeRowId} .inp-inv`).style.display = 'block';
                stopScanner();
            });
        }
        function stopScanner() { if(html5QrCode) html5QrCode.stop().then(()=>document.getElementById('qr-modal').style.display='none'); }

        // --- TOTALS & SAVE ---
        function calcTotals() {
            let t = 0;
            document.querySelectorAll('.inp-price').forEach(i => t += Number(i.value));
            document.getElementById('grand-total').innerText = t;
            const adv = Number(document.getElementById('adv-amt').value);
            document.getElementById('bal-amt').innerText = t - adv;
        }

        async function saveBill() {
            if(!billBookId) return alert("Select Salesman!");
            const btn = document.querySelector('.btn-gen');
            btn.innerText = "PROCESSING..."; btn.disabled = true;

            try {
                await updateBillSeries();
                const billNo = currentBillNumber;
                
                // DATA GATHERING
                const custName = document.getElementById('cust-name').value || 'Cash Customer';
                // Collect additional mobiles if any
                const allMobiles = Array.from(document.querySelectorAll('.cust-mobile')).map(i=>i.value).filter(v=>v).join(', ');

                const delDate = document.getElementById('del-date').value;
                const total = Number(document.getElementById('grand-total').innerText);
                const advance = Number(document.getElementById('adv-amt').value);
                
                // COURIER CHECKBOX
                const isCourier = document.getElementById('is-courier').checked;

                const items = [];
                const invUpdates = [];
                
                document.querySelectorAll('.item-card').forEach(card => {
                    const nm = card.querySelector('.inp-name').value;
                    const pr = card.querySelector('.inp-price').value;
                    const nt = card.querySelector('.inp-note').value;
                    const iv = card.querySelector('.inp-inv').value;
                    
                    const opts = [];
                    card.querySelectorAll('input[type="checkbox"]:checked').forEach(c => opts.push(c.value));
                    
                    if(nm) {
                        items.push({ name: nm, price: pr, note: nt, options: opts });
                        if(iv) invUpdates.push(iv);
                    }
                });

                if(items.length===0) throw new Error("Add Items");

                // SAVE DB
                const { data: bill, error } = await supabaseClient.from('bills').insert([{
                    bill_number: billNo, book_id: billBookId,
                    customer_name: custName, customer_mobile: allMobiles, delivery_date: delDate,
                    total_amount: total, received_amount: advance,
                    status: (invUpdates.length > 0) ? 'DELIVERED' : 'PENDING',
                    items_json: items, measurements: tempMeasurements,
                    is_courier: isCourier
                }]).select().single();

                if(error) throw error;

                if(advance > 0) {
                    await supabaseClient.from('bill_payments').insert([{
                        bill_id: bill.id, amount: advance, 
                        payment_mode: document.getElementById('pay-mode').value, payment_type: 'ADVANCE'
                    }]);
                }

                if(invUpdates.length > 0) {
                    await supabaseClient.from('inventory').update({ status: 'DELIVERED', bill_number: billNo }).in('pcs_id', invUpdates);
                }

                // PRINT
                const pData = {
                    billNo: billNo, date: new Date().toLocaleDateString(), time: new Date().toLocaleTimeString(),
                    customer: custName, mobile: allMobiles, delivery: delDate,
                    items: items.map(i => ({ desc: i.name, sub: i.options.join(', ')+' '+i.note, price: i.price })),
                    total: total, received: advance, balance: total - advance
                };
                localStorage.setItem('royal_print_queue', JSON.stringify(pData));
                window.open('print_template.html', '_blank');
                location.reload();

            } catch(e) {
                alert(e.message);
                btn.innerText = "GENERATE BILL"; btn.disabled = false;
            }
        }

        function openReprint() {
            const b = prompt("Bill No:");
            if(b) fetchAndPrint(b);
        }

        async function fetchAndPrint(b) {
            const { data } = await supabaseClient.from('bills').select('*').eq('bill_number', b).single();
            if(!data) return alert("Not Found");
            
            const pData = {
                billNo: data.bill_number, date: new Date(data.created_at).toLocaleDateString(),
                customer: data.customer_name, mobile: data.customer_mobile, delivery: data.delivery_date,
                items: data.items_json.map(i => ({ desc: i.name, sub: (i.options||[]).join(', '), price: i.price })),
                total: data.total_amount, received: data.received_amount, balance: data.total_amount - data.received_amount
            };
            localStorage.setItem('royal_print_queue', JSON.stringify(pData));
            window.open('print_template.html', '_blank');
        }

    </script>
</body>
</html>